//
//  FRLInteractionVC.m
//  FloatingRateLoanCalculator
//
//  Created by BobZhang on 16/12/15.
//  Copyright ¬© 2016Âπ¥ ZhangBaoGuo. All rights reserved.
//

#import "FRLInteractionVC.h"
#import "FloatingRateLoan.h"
#import <RETableViewManager.h>
#import "FRLCSettingManager.h"
#import "FRLResultVC.h"
#import "HousingProvidentFundLoanRateVC.h"
#import "InAppPurchaseProductListVC.h"
#import "FRLHistoryListVC.h"
#import "FRLStorer+CoreDataClass.h"
#import "KxMenu.h"
#import "FRLCAboutVC.h"
#import "WXApi.h"

#define kLastFRLData @"kLastFRLData"
#define SectionHeaderHeight 20

typedef BOOL (^OnChangeCharacterInRange)(RETextItem *item, NSRange range, NSString *replacementString);

@interface FRLInteractionVC ()<RETableViewManagerDelegate>

@property (strong,nonatomic) FloatingRateLoan *currentFRL;

@property (strong,nonatomic) RETableViewManager *reTVManager;
@property (nonatomic,strong) UITableView *loanTableView;

@property (strong,nonatomic) RETableViewSection *iRateForYearSection;

@end


@implementation FRLInteractionVC{
    NSMutableArray <RETextItem *> *iRateForYearItemMA;
    FRLCSettingManager *settingManager;
    
    NSArray <NSString *> *yearCountArray;
    
    RETableViewSection *loanInfoSection;
    
    RETextItem *totalTextItem;
    REPickerItem *yearCountPickerItem;
    REDateTimeItem *dateTimeItem;
    RESegmentedItem *repayTypeSegItem;
    RESegmentedItem *creditorTypeSegItem;
    RETextItem *customRateItem;
    
    UIButton *calculateButton;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    self.view.backgroundColor = [UIColor groupTableViewBackgroundColor];
    
    self.title = NSLocalizedString(@"ÊµÆÂä®Âà©ÁéáË¥∑Ê¨æËÆ°ÁÆóÂô®",@"Floating Rate Loan Calculator");
    
    self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemAdd target:self action:@selector(showMenu:)];
    
    yearCountArray = @[ NSLocalizedString(@"1Âπ¥",@"1 year"),
                        NSLocalizedString(@"2Âπ¥",@"2 years"),
                        NSLocalizedString(@"3Âπ¥",@"3 years"),
                        NSLocalizedString(@"4Âπ¥",@"4 years"),
                        NSLocalizedString(@"5Âπ¥",@"5 years"),
                        NSLocalizedString(@"6Âπ¥",@"6 years"),
                        NSLocalizedString(@"7Âπ¥",@"7 years"),
                        NSLocalizedString(@"8Âπ¥",@"8 years"),
                        NSLocalizedString(@"9Âπ¥",@"9 years"),
                        NSLocalizedString(@"10Âπ¥",@"10 years"),
                        NSLocalizedString(@"11Âπ¥",@"11 years"),
                        NSLocalizedString(@"12Âπ¥",@"12 years"),
                        NSLocalizedString(@"13Âπ¥",@"13 years"),
                        NSLocalizedString(@"14Âπ¥",@"14 years"),
                        NSLocalizedString(@"15Âπ¥",@"15 years"),
                        NSLocalizedString(@"16Âπ¥",@"16 years"),
                        NSLocalizedString(@"17Âπ¥",@"17 years"),
                        NSLocalizedString(@"18Âπ¥",@"18 years"),
                        NSLocalizedString(@"19Âπ¥",@"19 years"),
                        NSLocalizedString(@"20Âπ¥",@"20 years"),
                        NSLocalizedString(@"21Âπ¥",@"21 years"),
                        NSLocalizedString(@"22Âπ¥",@"22 years"),
                        NSLocalizedString(@"23Âπ¥",@"23 years"),
                        NSLocalizedString(@"24Âπ¥",@"24 years"),
                        NSLocalizedString(@"25Âπ¥",@"25 years"),
                        NSLocalizedString(@"26Âπ¥",@"26 years"),
                        NSLocalizedString(@"27Âπ¥",@"27 years"),
                        NSLocalizedString(@"28Âπ¥",@"28 years"),
                        NSLocalizedString(@"29Âπ¥",@"29 years"),
                        NSLocalizedString(@"30Âπ¥",@"30 years")];

    
    settingManager = [FRLCSettingManager defaultManager];
    
    self.currentFRL = [FloatingRateLoan new];
    self.currentFRL.firstRepayDate = [NSDate date];
    self.currentFRL.nYearCount = 3;
    
    if (DEBUGMODE){
        self.currentFRL.aTotal = 315000;
        self.currentFRL.nYearCount = 20;
        NSDateFormatter *dateFormatter = [NSDateFormatter new];
        [dateFormatter setDateFormat:@"yyyy-MM-dd"];
        self.currentFRL.firstRepayDate = [dateFormatter dateFromString:@"2015-05-01"];
    }
    
    [self initButton];
    [self initTableView];
    
    [self updateIRateForYearSection];
    
}

- (BOOL)addAndObservePraiseCountToDecideWhetherToContinue{
    settingManager.praiseCount++;
    
    if (settingManager.praiseCount == 5){
        
        [self askForPraise];
        settingManager.praiseCount = 0;
        return NO;
    }else{
        return YES;
    }
}

- (void)askForPraise{
    NSString *alertTitle = NSLocalizedString(@"ÊµÆÂä®Âà©ÁéáËÆ°ÁÆóÂô®",@"Floating Rate");
    NSString *alertMessage = NSLocalizedString(@"Ê≤°ÊúâÂπøÂëäÊòØ‰∏çÊòØÂæàÊ∏ÖÁàΩÔºü‰ΩúËÄÖ‰πü‰∏çÂÆπÊòìÔºåÊäΩÁ©∫Áªô‰∏™Â•ΩËØÑÂëóÔºÅüôè",@"Is it cool without any advertisements? The author is toil and moil. So take a little time to praise me, please!üôè");
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:alertTitle message:alertMessage preferredStyle:UIAlertControllerStyleAlert];
    
    UIAlertAction *okAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"ÂéªÁªôÂ•ΩËØÑ",@"Praise") style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        [[UIApplication sharedApplication]openURL:[NSURL URLWithString:settingManager.appURLString]];
    }];
    
    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"ÊÆãÂøçÊãíÁªù",@"I'm busy.") style:UIAlertActionStyleCancel handler:nil];
    [alertController addAction:okAction];
    [alertController addAction:cancelAction];
    
    if (iOS9) alertController.preferredAction = okAction;
    
    [self presentViewController:alertController animated:YES completion:nil];
}

- (void)showMenu:(UIBarButtonItem *)sender{
    float edgeLength = 20;
    CGRect rect = CGRectMake(ScreenWidth - edgeLength - 20, 0, edgeLength, edgeLength);
    
    [KxMenu setTintColor:[UIColor flatGreenColorDark]];
    [KxMenu showMenuInView:self.view
                  fromRect:rect
                 menuItems:@[
                             [KxMenuItem menuItem:NSLocalizedString(@"Êü•ËØ¢ÂéÜÂè≤",@"Query History")
                                            image:[UIImage imageNamed:@"image"]
                                           target:self
                                           action:@selector(historyAction)],
                             [KxMenuItem menuItem:NSLocalizedString(@"ÂÖ¨ÁßØÈáëÂà©Áéá",@"HPF Rate")
                                            image:[UIImage imageNamed:@"image"]
                                           target:self
                                           action:@selector(hpfAction)],
                             [KxMenuItem menuItem:NSLocalizedString(@"Ë¥≠‰π∞ÂíåÊÅ¢Â§ç",@"Purchase / Restore")
                                            image:[UIImage imageNamed:@"image"]
                                           target:self
                                           action:@selector(inAppAction)],
                             [KxMenuItem menuItem:NSLocalizedString(@"ÂæÆ‰ø°ÊúãÂèãÂúà",@"WeChat Timeline")
                                            image:[UIImage imageNamed:@"image"]
                                           target:self
                                           action:@selector(wxTimelineAction)],
                             [KxMenuItem menuItem:NSLocalizedString(@"ÂæÆ‰ø°Â•ΩÂèã",@"WeChat Session")
                                            image:[UIImage imageNamed:@"image"]
                                           target:self
                                           action:@selector(wxSessionAction)],
                             [KxMenuItem menuItem:NSLocalizedString(@"Áªô‰∏™Â•ΩËØÑ",@"Praise me")
                                            image:[UIImage imageNamed:@"image"]
                                           target:self
                                           action:@selector(praiseAction)],
                             [KxMenuItem menuItem:NSLocalizedString(@"ÂÖ≥‰∫é",@"About")
                                            image:[UIImage imageNamed:@"image"]
                                           target:self
                                           action:@selector(aboutAction)]
                             ]];
}

- (void)historyAction{
    if(![self addAndObservePraiseCountToDecideWhetherToContinue]) return;
    
    FRLHistoryListVC *vc = [FRLHistoryListVC new];
    vc.edgesForExtendedLayout = UIRectEdgeNone;
    [self.navigationController pushViewController:vc animated:YES];
}

- (void)hpfAction{
    [self.navigationController pushViewController:[HousingProvidentFundLoanRateVC new] animated:YES];
}

- (void)inAppAction{
    [self.navigationController pushViewController:[InAppPurchaseProductListVC new] animated:YES];
}

- (void)wxTimelineAction{
    [self wxShare:WXSceneTimeline];
}

- (void)wxSessionAction{
    [self wxShare:WXSceneSession];
}

- (void)praiseAction{
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:[FRLCSettingManager defaultManager].appURLString]];
}

- (void)aboutAction{
    FRLCAboutVC *aboutVC = [FRLCAboutVC new];
    aboutVC.edgesForExtendedLayout = UIRectEdgeNone;
    [self.navigationController pushViewController:aboutVC animated:YES];
}

#pragma mark - Simple WX Share

- (void)wxShare:(enum WXScene)wxScene{
    if (![WXApi isWXAppInstalled] || ![WXApi isWXAppSupportApi]){
        if(DEBUGMODE) NSLog(@"WeChat uninstalled or not support!");
        return;
    }
    
    WXWebpageObject *webpageObject=[WXWebpageObject new];
    webpageObject.webpageUrl = [FRLCSettingManager defaultManager].appURLString;
    
    WXMediaMessage *mediaMessage=[WXMediaMessage alloc];
    // WXWebpageObject : ‰ºöËØùÊòæÁ§∫title„ÄÅdescription„ÄÅthumbDataÔºàÂõæÊ†áËæÉÂ∞è)ÔºåÊúãÂèãÂúàÊòæÁ§∫title„ÄÅthumbDataÔºàÂõæÊ†áËæÉÂ∞è),‰∏§ËÄÖÈÉΩÂèëÈÄÅwebpageUrl
    // WXImageObject   : ‰ºöËØùÊòæÁ§∫ÂàÜ‰∫´ÁöÑÂõæÁâáÔºåÂπ∂‰ª•thumbData‰Ωú‰∏∫Áº©Áï•ÂõæÔºåÊúãÂèãÂúàÂè™ÊòæÁ§∫ÂàÜ‰∫´ÁöÑÂõæÁâá,‰∏§ËÄÖÈÉΩÂèëÈÄÅimageData
    mediaMessage.title = NSLocalizedString(@"ÊµÆÂä®Âà©ÁéáË¥∑Ê¨æËÆ°ÁÆóÂô®", @"Floating Rate Loan Calculator");
    mediaMessage.description = NSLocalizedString(@"ËøòÊ¨æÈáëÈ¢ù‰∏çÂØπÔºüÊù•ËØïËØïÊõ¥‰∏ì‰∏öÁöÑËÆ°ÁÆóÂô®ÂêßÔºÅÊØèÂπ¥Ë¥∑Ê¨æÂà©ÁéáËá™ÂÆö‰πâÔºåÊõ¥ÊúâÂÖ¨ÁßØÈáëÂà©ÁéáËá™Âä®Â°´ÂÖÖÔºÅ",@"Wrong monthly repayment? Try this professional loan rate calculator! Custom rate for every year!");
    mediaMessage.mediaObject = webpageObject;
    mediaMessage.thumbData = UIImageJPEGRepresentation([UIImage imageNamed:@"37-List 300_300"], 0.5);
    
    SendMessageToWXReq *req=[SendMessageToWXReq new];
    req.message=mediaMessage;
    req.bText=NO;
    req.scene= wxScene;
    
    BOOL succeeded=[WXApi sendReq:req];
    if(DEBUGMODE) NSLog(@"SendMessageToWXReq : %@",succeeded? @"Succeeded" : @"Failed");
}

- (void)initButton{
    calculateButton = [UIButton newAutoLayoutView];
    [calculateButton setTitle:NSLocalizedString(@"ÂºÄÂßãËÆ°ÁÆó",@"Calculate") forState:UIControlStateNormal];
    [calculateButton setStyle:UIButtonStyleSuccess];
    [calculateButton addTarget:self action:@selector(calculateBtnTD) forControlEvents:UIControlEventTouchDown];
    
    [self.view addSubview:calculateButton];
    [calculateButton autoSetDimension:ALDimensionHeight toSize:40];
    [calculateButton autoPinEdgesToSuperviewEdgesWithInsets:UIEdgeInsetsMake(0, 10, 10, 10) excludingEdge:ALEdgeTop];
}

- (void)initTableView{
    WEAKSELF(weakSelf);
    
    self.loanTableView = [[UITableView alloc] initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    self.loanTableView.translatesAutoresizingMaskIntoConstraints = NO;
    [self.view addSubview:self.loanTableView];
    [self.loanTableView autoPinEdgesToSuperviewEdgesWithInsets:UIEdgeInsetsZero excludingEdge:ALEdgeBottom];
    [self.loanTableView autoPinEdge:ALEdgeBottom toEdge:ALEdgeTop ofView:calculateButton withOffset:-10];
    
    self.reTVManager = [[RETableViewManager alloc] initWithTableView:self.loanTableView delegate:self];
    
    loanInfoSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"Ë¥∑Ê¨æ‰ø°ÊÅØ",@"Loan Information")];
    
    totalTextItem = [RETextItem itemWithTitle:NSLocalizedString(@"Ë¥∑Ê¨æÊÄªÈ¢ù",@"Total")
                                                  value:nil
                                            placeholder:NSLocalizedString(@"ËØ∑ËæìÂÖ•Ë¥∑Ê¨æÊÄªÈ¢ùÔºàÂçï‰ΩçÔºöÂÖÉÔºâ",@"Enter the total loan")];
    totalTextItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
    totalTextItem.keyboardType = UIKeyboardTypeDecimalPad;
    
    NSArray *valueArray = DEBUGMODE ? @[NSLocalizedString(@"20Âπ¥",@"20 years")] :@[NSLocalizedString(@"3Âπ¥",@"3 years")];
    yearCountPickerItem = [REPickerItem itemWithTitle:NSLocalizedString(@"Ë¥∑Ê¨æÂπ¥Èôê",@"Term")
                                                value:valueArray
                                          placeholder:NSLocalizedString(@"ËØ∑ÈÄâÊã©",@"Choose an item")
                                              options:@[yearCountArray]];
    yearCountPickerItem.onChange = ^(REPickerItem *item){
        weakSelf.currentFRL.nYearCount = [yearCountArray indexOfObject:item.value.firstObject] + 1;
        [weakSelf updateIRateForYearSection];
        [weakSelf.loanTableView scrollsToTop];
    };
    
    dateTimeItem=[REDateTimeItem itemWithTitle:NSLocalizedString(@"È¶ñÊ¨°ËøòÊ¨æ",@"First repay date")
                                                         value:self.currentFRL.firstRepayDate
                                                   placeholder:nil
                                                        format:@"yyyy-MM"
                                                datePickerMode:UIDatePickerModeDate];
    dateTimeItem.onChange = ^(REDateTimeItem *item){
        weakSelf.currentFRL.firstRepayDate = item.value;
        [weakSelf updateIRateForYearSection];
    };
    dateTimeItem.inlineDatePicker=YES;
    
    repayTypeSegItem=[RESegmentedItem itemWithTitle:NSLocalizedString(@"ËøòÊ¨æÊñπÂºè",@"Repay style")
                                              segmentedControlTitles:@[NSLocalizedString(@"Á≠âÈ¢ùÊú¨Èáë",@"Average C"),NSLocalizedString(@"Á≠âÈ¢ùÊú¨ÊÅØ",@"Average C&I")]
                                                               value:0
                                            switchValueChangeHandler:^(RESegmentedItem *item) {
                                                NSLog(@"Value: %ld", (long)item.value);
                                                self.currentFRL.repayType = item.value;
                                            }];
    
    customRateItem = [RETextItem itemWithTitle:NSLocalizedString(@"Ëá™ÂÆöÂà©Áéá",@"Custom rate")
                                         value:[NSString stringWithFormat:@"%.2f",[FRLCSettingManager defaultManager].lastCustomRate]
                                  placeholder:nil];
    customRateItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
    customRateItem.onEndEditing = ^(RETextItem *item){
        [FRLCSettingManager defaultManager].lastCustomRate = [item.value floatValue];
        [weakSelf updateIRateForYearSection];
    };
    customRateItem.onReturn = ^(RETextItem *item){
        [FRLCSettingManager defaultManager].lastCustomRate = [item.value floatValue];
        [weakSelf updateIRateForYearSection];
    };
    customRateItem.keyboardType = UIKeyboardTypeDecimalPad;

    creditorTypeSegItem = [RESegmentedItem itemWithTitle:NSLocalizedString(@"‰ΩøÁî®Âà©Áéá",@"Rate to use")
                             segmentedControlTitles:@[NSLocalizedString(@"ÂÖ¨ÁßØÈáë",@"HPF loan rate"),NSLocalizedString(@"Ëá™ÂÆö‰πâ",@"Custom rate")]
                                              value:1
                           switchValueChangeHandler:^(RESegmentedItem *item) {
                               if (item.value == LoanCreditorTypeCustom){
                                   [loanInfoSection addItem:customRateItem];
                               }else{
                                   [loanInfoSection removeItem:customRateItem];
                               }
                               
                               [weakSelf updateIRateForYearSection];
                           }];
    
    
    [loanInfoSection addItemsFromArray:@[totalTextItem,yearCountPickerItem,dateTimeItem,repayTypeSegItem,creditorTypeSegItem,customRateItem]];
    
    /*
    RETableViewSection *buttonSection=[RETableViewSection sectionWithHeaderTitle:nil];
    buttonSection.headerHeight = SectionHeaderHeight;
    RETableViewItem *buttonItem = [RETableViewItem itemWithTitle:NSLocalizedString(@"ÂºÄÂßãËÆ°ÁÆó",@"Calculate")
                                                   accessoryType:UITableViewCellAccessoryNone
                                                selectionHandler:^(RETableViewItem *item) {
                                                    [item reloadRowWithAnimation:UITableViewRowAnimationAutomatic];
                                                    [weakSelf calculateBtnTD];
                                                }];
    buttonItem.textAlignment = NSTextAlignmentCenter;
    [buttonSection addItem:buttonItem];
    */
    
    [self.reTVManager addSectionsFromArray:@[loanInfoSection]];

}

- (void)calculateBtnTD{
    if(![self addAndObservePraiseCountToDecideWhetherToContinue]) return;
    
    if (![self checkInput]) return;
    
    self.currentFRL.aTotal = [totalTextItem.value floatValue];
    self.currentFRL.nYearCount = [yearCountArray indexOfObject:yearCountPickerItem.value.firstObject] + 1;
    self.currentFRL.firstRepayDate = dateTimeItem.value;
    self.currentFRL.repayType = repayTypeSegItem.value;
    
    NSMutableArray <NSNumber *> *ma = [NSMutableArray new];
    for (RETextItem *iRateItem in iRateForYearItemMA) {
        [ma addObject:@([iRateItem.value floatValue])];
    }
    
    self.currentFRL.iRateForYearArray = ma;
    
    /*
    NSData *frlData = [NSKeyedArchiver archivedDataWithRootObject:self.currentFRL];
    [[NSUserDefaults standardUserDefaults] setObject:frlData forKey:kLastFRLData];
    [[NSUserDefaults standardUserDefaults] synchronize];
    */
    [FRLStorer newFRLStorerWithFloatingRateLoan:self.currentFRL inManagedObjectContext:AppContext];
    
    
    FRLResultVC *resultVC = [FRLResultVC new];
    resultVC.currentFRL = self.currentFRL;
    resultVC.edgesForExtendedLayout = UIRectEdgeNone;
    [self.navigationController pushViewController:resultVC animated:YES];
}

- (BOOL)checkInput{
    BOOL checkOK = YES;
    NSString *errorString;
    
    if ([totalTextItem.value floatValue] <= 0){
        errorString = NSLocalizedString(@"Ë¥∑Ê¨æÊÄªÈ¢ù‰∏çËÉΩ‰∏∫0„ÄÇ",@"The total loan can not be 0.");
        checkOK = NO;
    }
    
    for (RETextItem *iRateItem in iRateForYearItemMA) {
        if ([iRateItem.value floatValue] <= 0){
            errorString = NSLocalizedString(@"Âà©Áéá‰∏çËÉΩ‰∏∫0„ÄÇ",@"The loan rate can not be 0.");
            checkOK = NO;
        }
    }
    
    if (errorString){
        UIAlertController *ac = [UIAlertController informationAlertControllerWithTitle:NSLocalizedString(@"ÈîôËØØ",@"Error") message:errorString];
        [self presentViewController:ac animated:YES completion:nil];
    }
    return checkOK;
}

- (void)updateIRateForYearSection{
    [self.reTVManager removeSection:self.iRateForYearSection];
    
    iRateForYearItemMA = [NSMutableArray new];
    for (int yearIndex = 0; yearIndex < self.currentFRL.calculateYearCount; yearIndex++) {
        
        NSInteger currentYear = yearIndex + self.currentFRL.firstRepayYear;
        
        float loanRate = 0.0f;
        
        if (creditorTypeSegItem.value == LoanCreditorTypeHousingProvidentFund){
            NSDateFormatter *dateFormatter = [NSDateFormatter new];
            [dateFormatter setDateFormat:@"yyyy-MM-dd"];
            NSDate *aDate = [dateFormatter dateFromString:[NSString stringWithFormat:@"%ld-01-01",(long)currentYear]];
            
            if (yearIndex == 0) aDate = self.currentFRL.firstRepayDate;
            
            loanRate = [settingManager loanRateOfType:LoanCreditorTypeHousingProvidentFund moreThan5Years:self.currentFRL.nYearCount > 5 ? YES : NO beforeDate:aDate];
        }else if (creditorTypeSegItem.value == LoanCreditorTypeCustom){
            loanRate = [customRateItem.value floatValue];
        }
        
        RETextItem *iRateItem=[RETextItem itemWithTitle:yearCountArray[yearIndex]
                                                      value:[[NSString alloc]initWithFormat:@"%.2f",loanRate]
                                                placeholder:NSLocalizedString(@"Êú¨Âπ¥Âà©Áéá",@"Rate for year")];
        iRateItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
        iRateItem.keyboardType = UIKeyboardTypeDecimalPad;
        [iRateForYearItemMA addObject:iRateItem];
    }
    
    self.iRateForYearSection = [[RETableViewSection alloc] initWithHeaderTitle:NSLocalizedString(@"Âπ¥Â∫¶Âà©Áéá",@"Rates")];
    self.iRateForYearSection.headerHeight = SectionHeaderHeight;
    [self.iRateForYearSection addItemsFromArray:iRateForYearItemMA];
    [self.reTVManager insertSection:self.iRateForYearSection atIndex:1];
    [self.loanTableView reloadData];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - RE Block

-(OnChangeCharacterInRange)createLimitInputBlockWithAllowedString:(NSString *)string{
    OnChangeCharacterInRange block=^(RETextItem *item, NSRange range, NSString *replacementString){
        NSString *allowedString=string;
        NSCharacterSet *forbidenCharacterSet=[[NSCharacterSet characterSetWithCharactersInString:allowedString] invertedSet];
        NSArray *filteredArray=[replacementString componentsSeparatedByCharactersInSet:forbidenCharacterSet];
        NSString *filteredString=[filteredArray componentsJoinedByString:@""];
        
        if (![replacementString isEqualToString:filteredString]) {
            if(DEBUGMODE) NSLog(@"The character „Äê%@„Äë is not allowed!",replacementString);
        }
        
        return [replacementString isEqualToString:filteredString];
    };
    
    return block;
}

@end
